<html>
    <head>
        <link rel="stylesheet" type="text/css" href="css/ui-darkness/jquery-ui-1.8.2.custom.css">

        <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui-1.8.2.custom.min.js"></script>

        <style>
            body, div, a { font-family: 'Droid Sans', sans-serif; font-size: xx-large; }
            body { background: #111; }
            div.item { padding: 0.2em; }
            div.item a:link,
            div.item a:active,
            div.item a:hover,
            div.item a:visited,
            div.item a:focus {
                text-decoration: none;
                outline: none;
                vertical-align: middle;
            }
            div.item a img { vertical-align: middle; height: 1.8em; }
            div.item a span { vertical-align: middle; }
        </style>
    </head>

    <body>
        <div id="files"></div>
        <script>
            var old_el = null;

            var play_file = function(fullpath)
            {
                $.get('htpicker://play_file?fullpath=' + fullpath);
            }

            var activate = function(fullpath, type)
            {
                if(type == 'directory')
                    load_files(fullpath);
                else
                    play_file(fullpath);
            }

            var htmlDecode = function(input)
            {
                var e = document.createElement('div');
                e.innerHTML = input;
                return e.childNodes[0].nodeValue;
            }

            var focus_index = 0;
            var num_items = 0;

            var load_files = function(path) {
                var qs = '';
                if(path)
                    qs = '?directory=' + encodeURIComponent(path);

                $.getJSON('htpicker://list_files' + qs, function(data) {
                    var files = data['files'];
                    $('#files').html('');
                    num_items = files.length;
                    for(var i = 0; i < num_items; i++)
                    {
                        var css_classes = 'ui-widget-header item';

                        var focusin_cb = function(i) {
                            return function(ev) {
                                focus_index = i;
                                $('#file-'+i).addClass("ui-state-active");
                            };
                        }(i);

                        var focusout_cb = function(i) {
                            return function(ev) {
                                $('#file-'+i).removeClass("ui-state-active");
                            };
                        }(i);

                        if(files[i]['icon'] == 'directory')
                            var icon = 'images/G-Flat-SVG/gnome-fs-directory.svg';
                        else if(files[i]['icon'] == 'video')
                            var icon = 'images/G-Flat-SVG/gnome-mime-video.svg';
                        else if(files[i]['icon'] == 'game')
                            var icon = 'images/G-Flat-SVG/emulator-game.svg';
                        else
                            var icon = '';

                        var div = ($('<div>')
                            .attr('id', 'file-'+i)
                            .attr('class', css_classes)
                            .focusin(focusin_cb)
                            .focusout(focusout_cb)
                            .append(
                                $('<a>')
                                    .attr('href', '#')
                                    .click(function(file) {
                                        return function(ev) {
                                            activate(file['fullpath'], file['type']);
                                        };
                                    }(files[i]))
                                    .html('<img src="' + icon + '"> <span>' + files[i]['display_name'] + '</span>')
                            )
                        );
                        $('#files').append(div);
                        if(i == 0)
                            div.children()[0].focus();
                        focus_index = 0;
                    }
                });
            }

            $(function() {
                $.getJSON('htpicker://get_initial_dir', function(data) {
                    var initial_dir = data['initial_dir'];
                    load_files(initial_dir);
                });

                $(document).keydown(function(ev) {
                    if(ev.which == $.ui.keyCode.DOWN)
                    {
                        if(focus_index < num_items-1)
                        {
                            focus_index++;
                            $('#file-'+focus_index).children()[0].focus();
                        }
                        return false;
                    }

                    if(ev.which == $.ui.keyCode.UP)
                    {
                        if(focus_index > 0)
                        {
                            focus_index--;
                            $('#file-'+focus_index).children()[0].focus();
                        }
                        return false;
                    }
                });
            });
        </script>
    </body>
</html>
